# é€šè¿‡ Openssl å·¥å…·ç”Ÿæˆè‡ªç­¾åè¯ä¹¦

## ç®€ä»‹

åœ¨éƒ¨ç½² Web ç½‘ç«™çš„æ—¶å€™ï¼Œéœ€è¦ç”³è¯· SSL/TLS è¯ä¹¦æ‰èƒ½å¼€å¯ Https è®¿é—®ï¼Œè€Œå…è´¹çš„è¯ä¹¦ç”³è¯·æœºæ„ Letâ€™s Encrypt æ‰€é¢å‘çš„è¯ä¹¦ä¸€èˆ¬åªæœ‰ä¸‰ä¸ªæœˆæœ‰æ•ˆæœŸï¼Œè™½ç„¶å¯ä»¥é€šè¿‡è„šæœ¬å®ç°è‡ªåŠ¨ç»­æœŸï¼Œä½†å¦‚æœåªæ˜¯ä¸ªäººä½¿ç”¨åˆæˆ–è€…æ˜¯è¿›è¡Œæµ‹è¯•çš„è¯ï¼Œä½¿ç”¨å¯ä»¥è‡ªå®šä¹‰æœ‰æ•ˆæœŸçš„è‡ªç­¾åè¯ä¹¦ä¼šæ›´æ–¹ä¾¿ä¸€ç‚¹ã€‚æœ¬æ–‡å°†ä½¿ç”¨å¼€æºå·¥å…· Openssl æ¥å®ç°è‡ªç­¾åè¯ä¹¦çš„ç”Ÿæˆã€‚

## Openssl ä¸‹è½½å®‰è£…

å®˜æ–¹ä»“åº“å¹¶æ²¡æœ‰å‘å¸ƒå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸è¿‡åœ¨å®˜ç½‘ç»´æŠ¤äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹ä¸‹è½½çš„åœ°å€åˆ—è¡¨ï¼šhttps://wiki.openssl.org/index.php/Binaries

æˆ‘æ˜¯åœ¨ https://slproweb.com/products/Win32OpenSSL.html è¿™ä¸ªç½‘ç«™ä¸‹è½½çš„ï¼Œå…¶ä¸­æœ‰ `Win64 OpenSSL v3.3.2 Light` å’Œ `Win64 OpenSSL v3.3.2` ä¸¤ç§ç‰ˆæœ¬ï¼Œå« Light çš„æ˜¯è½»é‡ç‰ˆæœ¬ï¼Œå®‰è£…ååªæœ‰ 17MB å·¦å³ï¼Œå®Œæ•´ç‰ˆéœ€è¦ 700MB å·¦å³ï¼Œè¿™é‡Œé€‰æ‹©å®‰è£…è½»é‡ç‰ˆå°±å¤Ÿç”¨äº†ã€‚

å®‰è£…åç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶ä½äºç¨‹åºæ ¹ç›®å½•ä¸­çš„ `bin` ç›®å½•ï¼Œå¦‚æœéœ€è¦å…¨å±€å‘½ä»¤è¡Œè®¿é—®éœ€è¦æŠŠ `OpenSSL-Win64-light\bin` æ·»åŠ åˆ°ç¯å¢ƒå˜é‡çš„ `PATH` ä¸­ï¼ˆæ³¨ï¼šè¯¥æ–‡ç« æ‰€æœ‰æ“ä½œå‡åœ¨ Win ç³»ç»Ÿä¸‹å®Œæˆï¼ŒLinux ç³»ç»Ÿè‡ªè¡Œèä¼šè´¯é€šï¼‰ã€‚

## è¯ä¹¦é¢å‘æµç¨‹

?> æ³¨ï¼šæ­¤å°èŠ‚ä¸ºåŸç†ï¼Œå¦‚æœä½ åªæƒ³å¿«é€Ÿç”Ÿæˆè¯ä¹¦è¯·çœ‹ [å®æ“](#å®é™…æ“ä½œ) ç¯‡

### 1. ç”Ÿæˆç§é’¥

ç”Ÿæˆç§é’¥æœ‰ä»¥ä¸‹ä¸¤ä¸ªä¸åŒçš„å‚æ•°å¯é€‰ï¼š

- genpkey
- genrsa

ä»¥ä¸‹åˆ†åˆ«å±•ç¤ºä¸¤ç§å‘½ä»¤çš„ç”¨æ³•ï¼š

#### genpkey

```bash
openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 -out private.pem
```

`-algorithm RSA`ï¼šä½¿ç”¨ RSA ç®—æ³•ã€‚

`-pkeyopt rsa_keygen_bits:2048`ï¼šRSA å¯†é’¥é•¿åº¦ä¸º 2048ã€‚

> RSA åŠ å¯†ç®—æ³•ï¼šå¯†é’¥ä½æ•°è¶Šé•¿ï¼Œè¶Šå®‰å…¨ï¼Œä½†é€Ÿåº¦è¶Šæ…¢ï¼Œä¸€èˆ¬æ¨è 2048 ä½ï¼Œç›®å‰å¹¿æ³›ä½¿ç”¨ï¼Œå…¶ä»–åŠ å¯†ç®—æ³•å¦‚ï¼šECDSAã€EdDSAã€DSA ç­‰è‡ªè¡Œäº†è§£ã€‚

ä»¥ä¸Šå‘½ä»¤æ‰§è¡Œåä¼šç”Ÿæˆç§é’¥æ–‡ä»¶ `private.pem` ï¼Œ

#### genrsa

> è¯¥å‘½ä»¤ä¸“é—¨ç”¨äºç”Ÿæˆ `RSA` ç§é’¥ã€‚

```bash
# ç”Ÿæˆä¸€ä¸ª 4096 ä½çš„ RSA ç§é’¥
openssl genrsa -out private.pem 4096

# æŸ¥çœ‹ç§é’¥æ–‡ä»¶ä¿¡æ¯
 openssl rsa -in private.pem -text -noout -check
```

### 2. ç”Ÿæˆè¯ä¹¦è¯·æ±‚ csr æ–‡ä»¶

```bash
# ç”Ÿæˆ request.csr æ–‡ä»¶
openssl req -new \
    -key private.pem \
    -out request.csr \
    -subj "/C=CN/ST=Zhejiang/L=Hangzhou/O=Example Inc/OU=IT/CN=acbye.cn/emailAddress=ac@acbye.cn"

# æŸ¥çœ‹ csr æ–‡ä»¶ä¿¡æ¯
openssl req -in request.csr -text -noout
```

`-key private.key`ï¼šæŒ‡å®šç”¨äºç”Ÿæˆ CSR çš„ç§é’¥æ–‡ä»¶ã€‚

`-subj`ï¼šæŒ‡å®šä¸»ä½“ä¿¡æ¯ï¼Œä»¥ `/` å¼€å¤´ï¼Œåé¢è·Ÿç€ä¸€ç³»åˆ—é”®å€¼å¯¹ï¼Œæ ¼å¼ä¸º `key=value`ã€‚è¿™äº›é”®å€¼å¯¹åŒ…æ‹¬ï¼š

- Cï¼šå›½å®¶ä»£ç ï¼ˆä¸¤ä½å­—æ¯ï¼‰ï¼Œå¦‚ï¼šCN
- STï¼šçœä»½æˆ–å·åï¼Œå¦‚ï¼šZhe jiang
- Lï¼šåŸå¸‚åï¼Œå¦‚ï¼šHang zhou
- Oï¼šç»„ç»‡åï¼Œå¦‚ï¼šExample Inc
- OUï¼šç»„ç»‡éƒ¨é—¨åï¼Œå¦‚ï¼šIT
- CNï¼šé€šç”¨åç§°ï¼ˆé€šå¸¸æ˜¯åŸŸåæˆ–æœåŠ¡å™¨åï¼‰ï¼Œå¦‚ï¼šacbye.cn
- emailAddressï¼šç”µå­é‚®ä»¶åœ°å€ï¼Œå¦‚ï¼šac@acbye.cn

è¿˜å¯ä»¥ä¸€æ¡å‘½ä»¤åŒæ—¶ç”Ÿæˆç§é’¥å’Œ CSR æ–‡ä»¶ï¼š

```bash
openssl req -new \
    -newkey rsa:2048 \
    -keyout private.pem \
    -nodes \
    -out request.csr \
    -subj "/C=CN/ST=Zhejiang/L=Hangzhou/O=Example Inc/OU=IT/CN=acbye.cn/emailAddress=ac@acbye.cn"
```

`-nodes`ï¼šä¸ä½¿ç”¨å¯†ç 

### 3. æäº¤ CSR æ–‡ä»¶ç»™ CA æœºæ„ç”³è¯·è¯ä¹¦

è¿™ä¸€æ­¥éœ€è¦æäº¤ç”Ÿæˆçš„ CSR æ–‡ä»¶ç»™ CA æœºæ„ï¼Œåœ¨é€šè¿‡éªŒè¯åå°±å¯ä»¥å¾—åˆ°é¢å‘çš„è¯ä¹¦æ–‡ä»¶ï¼Œä¸è¿‡ç”±äºæˆ‘ä»¬æ˜¯è¦åˆ›å»ºè‡ªç­¾åè¯ä¹¦ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå·±å°±æ˜¯ä¸€ä¸ª CAï¼Œåˆ›å»ºè¯ä¹¦çš„å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
openssl x509 -req \
    -days 3650 \
    -in request.csr \
    -sha256 \
    -signkey private.pem \
    -out cert.crt

# æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯
openssl x509 -in cert.crt -text -noout
```

`x509`ï¼šç”Ÿæˆ X509 æ ‡å‡†çš„è¯ä¹¦ã€‚

`-days 3650`ï¼šè¯ä¹¦æœ‰æ•ˆæœŸ 3650 å¤©ã€‚

`-in request.csr`ï¼šè¯ä¹¦ç”³è¯·æ–‡ä»¶ã€‚

`sha256`ï¼šä½¿ç”¨ SHA256 ç®—æ³•è¿›è¡Œç­¾åã€‚

`-signkey private.pem`ï¼šæŒ‡å®šç§é’¥æ–‡ä»¶ï¼Œç”¨äºå¯¹ç”Ÿæˆçš„è¯ä¹¦è¿›è¡Œç­¾åï¼Œç”¨è‡ªå·±çš„ç§é’¥ç»™è‡ªå·±çš„è¯ä¹¦ç­¾åå°±æ˜¯è‡ªç­¾åè¯ä¹¦ã€‚

ç»è¿‡ä¸Šè¿°æ­¥éª¤å°±å¾—åˆ°äº†å¯ä»¥ä½¿ç”¨çš„è‡ªç­¾åè¯ä¹¦ï¼Œä¸è¿‡è¿™å¥—æµç¨‹ä¸‹æ¥æœªå…å¤ªè¿‡äºç¹çï¼Œæ¥ä¸‹æ¥æ˜¯ Show Time ğŸ˜ã€‚

## å®é™…æ“ä½œ

```bash
openssl req -x509 \
    -newkey rsa:4096 \
    -sha256 \
    -days 3650 \
    -nodes -keyout rootCA-key.pem \
    -subj "/C=CN/ST=Fu Jian/L=FuZhou/O=IT/CN=AC Personal CA/emailAddress=ca@acbye.cn" -out rootCA.crt
```

åªéœ€ä¸Šé¢è¿™ä¸€è¡Œå‘½ä»¤ï¼Œå°±å¯ä»¥ç”Ÿæˆè‡ªç­¾åè¯ä¹¦äº†ï¼Œå²‚ä¸å¦™å“‰ ğŸ˜ã€‚

ä¸è¿‡è‡ªç­¾åè¯ä¹¦æ˜¯ä¸è¢«æµè§ˆå™¨ä¿¡ä»»çš„ï¼Œéœ€è¦æŠŠè¯ä¹¦å¯¼å…¥åˆ°ç³»ç»Ÿ **_å—ä¿¡ä»»çš„è¯ä¹¦é¢å‘æœºæ„_** ä¸­è§£å†³ï¼Œå¦‚æœä½ éœ€è¦å¤šä¸ªè‡ªç­¾åè¯ä¹¦ï¼Œè¿™æ ·ä¸€ä¸ªä¸ªå¯¼å…¥æŒºéº»çƒ¦çš„ï¼Œæ‰€æœ‰æˆ‘ä»¬å¯ä»¥ç”Ÿæˆä¸€ä¸ª 10 å¹´çš„æ ¹è¯ä¹¦ï¼Œç„¶åç”¨è¿™ä¸ªæ ¹è¯ä¹¦å»ç­¾åå…¶ä»–çš„è¯ä¹¦ï¼Œè¿™æ ·å°±åªéœ€è¦æŠŠæ ¹è¯ä¹¦å¯¼å…¥ç³»ç»Ÿå³å¯ã€‚

ä¸Šé¢çš„å‘½ä»¤ç¤ºä¾‹å…¶å®å°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªæ ¹è¯ä¹¦ï¼Œä»–ä¸æ™®é€šè¯ä¹¦æ— å¼‚ï¼Œåªæ˜¯åå­—å«è¿™ä¸ªç½¢äº†ï¼Œä¸‹é¢æ¼”ç¤ºæ€ä¹ˆç”¨å®ƒå»ç­¾ååˆ«çš„è¯ä¹¦ï¼š

```bsah
openssl req -x509 \
    -newkey rsa:2048 \
    -sha256 \
    -days 900 \
    -nodes -keyout acbye.cn-key.pem \
    -CA rootCA.crt \
    -CAkey rootCA-key.pem \
    -subj "/C=CN/ST=Fu Jian/L=FuZhou/O=IT/CN=acbye.cn/emailAddress=ac@acbye.cn" \
    -addext "subjectAltName=DNS:acbye.cn,DNS:*.acbye.cn" -out acbye.cn.crt
```

`-CA`ï¼šå³ä¸ºè¦ä½¿ç”¨çš„æ ¹è¯ä¹¦ã€‚

`-CAkey`ï¼šä¸ºæ ¹è¯ä¹¦çš„ç§é’¥ã€‚

`subjectAltName=DNS:acbye.cn,DNS:*.acbye.cn`ï¼šæ·»åŠ åŸŸåï¼Œå¤šä¸ªåŸŸåç”¨é€—å·éš”å¼€ï¼Œå…¶ä¸­ `*.acbye.cn` ä¸ºé€šé…ç¬¦ï¼Œè¡¨ç¤º acbye.cn åŠå…¶å­åŸŸåéƒ½å¯ä»¥ç”¨è¿™ä¸ªè¯ä¹¦ï¼Œåˆç§°ä¸ºæ³›åŸŸåè¯ä¹¦ã€‚

`-out acbye.cn.crt`ï¼šè¯ä¹¦æ–‡ä»¶ã€‚

`-keyout acbye.cn-key.pem`ï¼šè¯ä¹¦çš„ç§é’¥æ–‡ä»¶ã€‚

ç°åœ¨ä½ å·²ç»å­¦ä¼šäº†åˆ›å»ºè‡ªç­¾åè¯ä¹¦äº†ï¼Œæ¥ä¸‹æ¥å¿«å»æ‰‹æ“ä¸€ä¸ªç½‘ç«™å§ ğŸ˜†ã€‚
